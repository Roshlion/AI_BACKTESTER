# README.md

# AI Backtester (S3-First, Next.js 14)

Web-based, AI-powered strategy backtesting over historical market data stored as **Parquet** in **AWS S3**. The application features a modern three-tab interface for comprehensive trading strategy development and analysis.

## New Three-Tab Navigation

**Dashboard** (default): Multi-ticker selection with interactive charts, indicator configuration, and seamless handoff to Strategy Lab.

**Strategy Lab**: AI-powered strategy generation with natural language prompts, sector-based ticker selection, and comprehensive backtesting capabilities.

**Data Warehouse**: Comprehensive data exploration with filtering, searching, and metadata viewing for all available datasets.

## Key Features

### Dashboard
- **Multi-ticker selection**: Full-row highlight selection with search filtering
- **Eye icon deep linking**: Click the eye icon to view any ticker in the Data Warehouse
- **Isolate action**: Context menu to focus on a single ticker
- **Indicator configuration**: Toggle SMA/EMA with editable periods, RSI (14), and MACD (12,26,9)
- **Auto date range**: Automatically computes date range from selected tickers' data spans
- **Create strategy handoff**: Seamlessly switches to Strategy Lab with pre-filled context

### Strategy Lab
- **Prefill from Dashboard**: Accepts tickers, indicators, and date ranges from Dashboard or URL
- **Sector selection**: Multi-select sectors to automatically include all tickers from those sectors (if sector data available)
- **AI strategy generation**: Natural language prompts converted to executable DSL
- **Standalone operation**: Works independently when accessed directly without prefill

### Data Warehouse
- **Symbol-level pages**: Deep link support (e.g., `/explore?symbol=AAPL`) for detailed ticker views
- **Comprehensive filtering**: Search by ticker, sector, industry; date range filtering; sortable columns
- **Metadata exploration**: Records count, date ranges, file formats, sector classifications

### Chart Readability & Performance
- **Series management**: Click legend to hide/show individual tickers; hover for emphasis
- **Multi-scale support**: Price (absolute), Indexed % (normalized to 100), Small multiples (grid view)
- **Indicator panels**: RSI and MACD in separate sub-panels with reference lines
- **Performance optimization**: Automatic downsampling for >5k data points
- **Error boundaries**: Graceful handling of missing data for selected symbols

## Architecture

- Frontend: Next.js 14 (App Router, RSC), TailwindCSS, Recharts
- APIs (Node runtime):
    - GET `/api/health` — pings manifest in S3
    - GET `/api/index` — returns the S3 manifest (tickers, asOf, source)
    - GET `/api/local-data?ticker=XYZ&start=YYYY-MM-DD&end=YYYY-MM-DD` — returns normalized OHLCV rows
    - POST `/api/strategy/generate` — `{ prompt } → { dsl }` using OpenAI
    - POST `/api/strategy/run` — executes `{ mode: "dsl" | "ml", dsl | code, tickers, startDate, endDate }`
- Libraries:
    - `lib/env.ts` — strict env loader (AWS_BUCKET, AWS_REGION, AWS_PREFIX, S3_BASE, OPENAI_*)
    - `lib/*` — ingestion/parquet fetch + strategy engine (indicators + backtest loop)
- Scripts:
    - `scripts/build-manifest.ts` — walks `s3://bucket/prefix/` and writes `index.json` (no ACLs)

## Repository Layout

- `app/`
    - `(shell)/` — Main application shell with three-tab layout
        - `dashboard/` — Multi-ticker Dashboard with selection and indicators
        - `strategy/` — Strategy Lab with AI generation and sector selection
        - `explore/` — Data Warehouse for dataset exploration
    - `store/` — Zustand global state for strategy handoff
    - `api/` — Next.js API routes (Node runtime)
- `lib/`
    - `env.ts` — environment helpers
    - `safeParquet.ts`, `ingest-bars.ts` — Parquet/CSV loaders + normalization (see docs)
    - `strategy-engine.ts` — DSL execution, indicators (SMA/EMA/RSI/MACD)
    - `colors.ts` — chart color palette for multi-ticker readability
    - `downsample.ts` — chart performance optimization utilities
- `components/`
    - `MultiTickerChart.tsx` — enhanced chart with multi-ticker support and readability features
- `scripts/`
    - `build-manifest.ts` — generates `index.json` manifest in S3
    - `check-page-exports.js` — validates Next.js App Router page exports
- `tests/`
    - `normalizers.test.ts`, `indicators.test.ts` — Vitest unit tests
    - `pages-exports.test.ts` — validates page export compliance
    - `dashboard-select.test.tsx` — Dashboard ticker selection functionality
    - `dashboard-to-strategy-handoff.test.tsx` — Strategy Lab handoff testing
    - `chart-readability.test.tsx` — Multi-ticker chart feature testing

## Data & Manifest

- S3 layout (example):
    - `s3://ai-backtester-data-rosh/prod/`
        - `AAPL.parquet`
        - `ABBV.parquet`
        - `...`
        - `index.json`  (generated by `build-manifest.ts`)

- Manifest example (trimmed):

        {
          "asOf": "2025-09-23T16:58:40.098Z",
          "source": "s3://ai-backtester-data-rosh/prod/",
          "tickers": ["AAPL","ABBV","..."]
        }

- Expected normalized row shape (before charts/backtests):

        {
          "date": "2025-01-02",
          "open": 170.2,
          "high": 172.0,
          "low": 169.5,
          "close": 171.8,
          "volume": 75000000
        }

## Environment Variables

Keep `.env.local` as the source of truth locally; replicate these in Vercel → Project Settings → Environment Variables (Production + Preview).

- Required:

        AWS_BUCKET=ai-backtester-data-rosh
        AWS_REGION=us-east-1
        AWS_PREFIX=prod
        S3_BASE=https://ai-backtester-data-rosh.s3.amazonaws.com/prod
        OPENAI_API_KEY=sk-...
        OPENAI_MODEL=gpt-4o-mini
        NEXT_PUBLIC_APP_URL=http://localhost:3000   # or your Vercel URL for prod

## Local Development

1) Install deps:

        npm ci

2) Build or refresh the S3 manifest:

        npm run build:manifest

3) Run dev server:

        npm run dev
        # http://localhost:3000

4) Quick smoke checks:

        curl.exe http://localhost:3000/api/health
        curl.exe http://localhost:3000/api/index | Select-Object -First 40
        curl.exe "http://localhost:3000/api/local-data?ticker=AAPL&start=2023-01-01&end=2024-12-31" | Select-Object -First 20

## Backtesting (Quick Start)

- Open `/backtester`, enter a prompt like:
    - “EMA 12/26 long on cross up; exit on cross down”
- Choose one or more tickers, pick a date range, and run.
- You’ll see equity curve, trades, and summary stats.

## Testing

- Type & unit tests:

        npm run typecheck
        npm run test

## Developer Notes

### App Router Page Exports
- All `app/**/page.tsx` files must only export allowed Next.js exports: `default`, `generateMetadata`, `generateStaticParams`, `revalidate`, `dynamic`, `dynamicParams`, `fetchCache`, `runtime`, `preferredRegion`, `maxDuration`, `metadata`
- Helper functions must be moved to `utils.ts` files in the same directory
- Use `npm run check-page-exports` or `node scripts/check-page-exports.js` to validate compliance

### Strategy Page Server→Client Pattern
- `app/(shell)/strategy/page.tsx` is a Server Component that parses `searchParams` and passes values to `StrategyClient` wrapped in `<Suspense>`
- `StrategyClient.tsx` is a Client Component that renders the Strategy Lab UI
- Uses `dynamic='force-dynamic'` and `revalidate=0` for fresh data on each request

### Global State Handoff
- Zustand store in `app/store/strategyStore.ts` manages strategy handoff between Dashboard and Strategy Lab
- Dashboard calls `setStrategy()` with tickers, indicators, and date range, then navigates to `/strategy`
- Strategy Lab reads from URL params if present, otherwise falls back to store values

## Deploying to Vercel

1) Push `main` to your Git host (the one Vercel is connected to).
2) In Vercel Dashboard → Project → Environment Variables, add the variables listed above (Production + Preview).
3) Trigger a redeploy (Dashboard Redeploy or `vercel --prod`).
4) Verify:

        curl https://<your-app>/api/health
        curl https://<your-app>/api/index | Select-Object -First 40

## Troubleshooting

- Vercel build error: “stream did not contain valid UTF-8” for `app/.../page.tsx`  
  Cause: files saved with non-UTF-8 or CRLF; fix by re-saving as UTF-8 LF and committing `.gitattributes`:
    - Ensure editor saves `app/dashboard/page.tsx` and `app/strategy/page.tsx` as **UTF-8 (LF)**.
    - Add `.gitattributes` line: `* text=auto eol=lf`
    - Commit and redeploy.

- Charts flat at 0 for non-AAPL tickers  
  Most likely normalization gaps (schema variants, DECIMAL scales, BigInt). See `DOCUMENTATION.md` → Parquet normalization. Ensure the loader:
    - Maps aliases (open|o|OpenPrice, high|h|HighPrice, low|l|LowPrice, close|c|ClosePrice, volume|v|Volume)
    - Handles decimals (divide by 10^scale when applicable)
    - Converts BigInt/Int64 to JS number
    - Skips invalid rows rather than defaulting to 0

- Missing env variables  
  App uses `.env.local` automatically. For manual CLI tests, export needed vars into the shell or sync from `.env.local`.

## Notes

- Polygon is not required for core operation; S3 Parquet is the data source. Polygon can be used later for refresh jobs.
- ML strategies are scaffolded and intentionally disabled in serverless paths; wire up a Python service when ready.

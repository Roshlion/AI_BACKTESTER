# README.md

# AI Backtester (S3-First, Next.js 14)

Web-based, AI-powered strategy backtesting over historical market data stored as **Parquet** in **AWS S3**. Users can:
- Browse available datasets from an S3 **manifest** (`index.json`)
- Generate strategies from **natural language** (OpenAI → DSL)
- Run **backtests** (SMA/EMA/RSI/MACD, crossovers, thresholds)
- Visualize **prices** and **equity curves** in the UI
- (Future) Run **ML strategies** via Python

## Features

- S3-first data access: reads Parquet/CSV over HTTPS from `s3://<bucket>/<prefix>/` (no local fs)
- Manifest-driven: `index.json` in S3 lists tickers & metadata for Dashboard/Data Explorer
- AI backtester: `/api/strategy/generate` converts prompts to DSL; `/api/strategy/run` executes it
- Dashboard comparisons: full-row multi-select with "only" isolation, adjustable SMA/EMA/RSI/MACD overlays, auto-fit date ranges with reset, and a responsive layout that stacks cleanly on mobile before routing into the Strategy Lab
- Strategy hand-off: `/strategy` consumes server-parsed query params and pre-fills tickers, indicator hints, and date range in a client component so users can tweak prompt/DSL before running a backtest
- Charts & UI: Recharts + Tailwind with multi-ticker overlays, indicator toggles, quick hand-offs to the Strategy Lab, and guardrails to avoid App Router suspense issues
- Tests: Vitest unit tests for normalizers/engine helpers

## Architecture

- Frontend: Next.js 14 (App Router, RSC), TailwindCSS, Recharts
- APIs (Node runtime):
    - GET `/api/health` — pings manifest in S3
    - GET `/api/index` — returns the S3 manifest (tickers, asOf, source)
    - GET `/api/local-data?ticker=XYZ&start=YYYY-MM-DD&end=YYYY-MM-DD` — returns normalized OHLCV rows
    - POST `/api/strategy/generate` — `{ prompt } → { dsl }` using OpenAI
    - POST `/api/strategy/run` — executes `{ mode: "dsl" | "ml", dsl | code, tickers, startDate, endDate }`
- Libraries:
    - `lib/env.ts` — strict env loader (AWS_BUCKET, AWS_REGION, AWS_PREFIX, S3_BASE, OPENAI_*)
    - `lib/*` — ingestion/parquet fetch + strategy engine (indicators + backtest loop)
- Scripts:
    - `scripts/build-manifest.ts` — walks `s3://bucket/prefix/` and writes `index.json` (no ACLs)

## Repository Layout

- `app/`
    - `dashboard/` — Dashboard UI: multi-select tickers, indicator overlays, strategy shortcut
    - `strategy/` — AI backtester interface (DSL editor, prefilled via dashboard shortcut)
    - `api/` — Next.js API routes (Node runtime)
- `lib/`
    - `env.ts` — environment helpers
    - `safeParquet.ts`, `ingest-bars.ts` — Parquet/CSV loaders + normalization (see docs)
    - `strategy-engine.ts` — DSL execution, indicators (SMA/EMA/RSI/MACD)
- `scripts/`
    - `build-manifest.ts` — generates `index.json` manifest in S3
- `tests/`
    - `normalizers.test.ts` — Vitest unit tests

## Data & Manifest

- S3 layout (example):
    - `s3://ai-backtester-data-rosh/prod/`
        - `AAPL.parquet`
        - `ABBV.parquet`
        - `...`
        - `index.json`  (generated by `build-manifest.ts`)

- Manifest example (trimmed):

        {
          "asOf": "2025-09-23T16:58:40.098Z",
          "source": "s3://ai-backtester-data-rosh/prod/",
          "tickers": ["AAPL","ABBV","..."]
        }

- Expected normalized row shape (before charts/backtests):

        {
          "date": "2025-01-02",
          "open": 170.2,
          "high": 172.0,
          "low": 169.5,
          "close": 171.8,
          "volume": 75000000
        }

## Environment Variables

Keep `.env.local` as the source of truth locally; replicate these in Vercel → Project Settings → Environment Variables (Production + Preview).

- Required:

        AWS_BUCKET=ai-backtester-data-rosh
        AWS_REGION=us-east-1
        AWS_PREFIX=prod
        S3_BASE=https://ai-backtester-data-rosh.s3.amazonaws.com/prod
        OPENAI_API_KEY=sk-...
        OPENAI_MODEL=gpt-4o-mini
        NEXT_PUBLIC_APP_URL=http://localhost:3000   # or your Vercel URL for prod

## Local Development

1) Install deps:

        npm ci

2) Build or refresh the S3 manifest:

        npm run build:manifest

3) Run dev server:

        npm run dev
        # http://localhost:3000

4) Quick smoke checks:

        curl.exe http://localhost:3000/api/health
        curl.exe http://localhost:3000/api/index | Select-Object -First 40
        curl.exe "http://localhost:3000/api/local-data?ticker=AAPL&start=2023-01-01&end=2024-12-31" | Select-Object -First 20

## Backtesting (Quick Start)

- Open `/backtester`, enter a prompt like:
    - “EMA 12/26 long on cross up; exit on cross down”
- Or jump from the dashboard via **Create a strategy with this** to pre-fill tickers/indicators.
- Choose one or more tickers, pick a date range, and run.
- You’ll see equity curve, trades, and summary stats.

## Testing

- Type & unit tests:

        npm run typecheck
        npm run test

## Deploying to Vercel

1) Push `main` to your Git host (the one Vercel is connected to).
2) In Vercel Dashboard → Project → Environment Variables, add the variables listed above (Production + Preview).
3) Trigger a redeploy (Dashboard Redeploy or `vercel --prod`).
4) Verify:

        curl https://<your-app>/api/health
        curl https://<your-app>/api/index | Select-Object -First 40

## Troubleshooting

- Vercel build error: “stream did not contain valid UTF-8” for `app/.../page.tsx`  
  Cause: files saved with non-UTF-8 or CRLF; fix by re-saving as UTF-8 LF and committing `.gitattributes`:
    - Ensure editor saves `app/dashboard/page.tsx` and `app/strategy/page.tsx` as **UTF-8 (LF)**.
    - Add `.gitattributes` line: `* text=auto eol=lf`
    - Commit and redeploy.

- Charts flat at 0 for non-AAPL tickers  
  Most likely normalization gaps (schema variants, DECIMAL scales, BigInt). See `DOCUMENTATION.md` → Parquet normalization. Ensure the loader:
    - Maps aliases (open|o|OpenPrice, high|h|HighPrice, low|l|LowPrice, close|c|ClosePrice, volume|v|Volume)
    - Handles decimals (divide by 10^scale when applicable)
    - Converts BigInt/Int64 to JS number
    - Skips invalid rows rather than defaulting to 0

- Missing env variables  
  App uses `.env.local` automatically. For manual CLI tests, export needed vars into the shell or sync from `.env.local`.

## Notes

- Polygon is not required for core operation; S3 Parquet is the data source. Polygon can be used later for refresh jobs.
- ML strategies are scaffolded and intentionally disabled in serverless paths; wire up a Python service when ready.

### Strategy Page (Next.js App Router)
The `/strategy` page reads query params via `Page({ searchParams })` in a Server Component and passes them into a Client Component wrapped in `<Suspense>`.
**Do not** use `useSearchParams()` inside a Server Component. If client-side URL access is required, ensure the component tree is inside a `<Suspense>` boundary.
The page exports `dynamic = 'force-dynamic'` and `revalidate = 0` to avoid SSG bailouts for query-driven UI.

### App Router page exports
`app/**/page.tsx` files must only export the fields supported by Next.js (e.g., `default`, `dynamic`, `revalidate`).
Move helpers into sibling modules such as `utils.ts` or keep them non-exported inside the page file. A regression test (`tests/pages.exports.test.ts`) watches for disallowed exports.

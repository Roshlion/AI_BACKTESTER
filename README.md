# README.md

# AI Backtester (S3-First, Next.js 14)

Web-based, AI-powered strategy backtesting over historical market data stored as **Parquet** in **AWS S3**. Users can:
- Browse available datasets from an S3 **manifest** (`index.json`)
- Generate strategies from **natural language** (OpenAI → DSL)
- Run **backtests** (SMA/EMA/RSI/MACD, crossovers, thresholds)
- Visualize **prices** and **equity curves** in the UI
- (Future) Run **ML strategies** via Python

## Features

- Three-tab workspace (Dashboard / Strategy Lab / Data Warehouse) with a shared app shell and global context store
- Multi-ticker dashboard: search, full-row selection, isolate control, and eye link that deep-links into the warehouse
- Indicator overlays: SMA/EMA (editable periods), RSI, MACD with dedicated panels, scale modes (absolute, indexed, small multiples)
- Strategy Lab hand-off: dashboard selections populate tickers/indicators/dates via global context or URL parameters
- Strategy Lab sector filters (when `public/sectors.json` or manifest metadata is present) auto-select relevant tickers
- Data Warehouse: searchable symbol index with single-ticker chart, stats, and shortcut back to the dashboard
- S3-first data access: reads Parquet/CSV over HTTPS from `s3://<bucket>/<prefix>/` (no local fs)
- Manifest-driven: `index.json` in S3 lists tickers & metadata for dashboard and warehouse pages
- AI backtester: `/api/strategy/generate` converts prompts to DSL; `/api/strategy/run` executes it
- Tests: Vitest coverage for page exports, dashboard UX, chart behaviours, and strategy prefills

## Architecture

- Frontend: Next.js 14 (App Router, RSC), TailwindCSS, Recharts
- APIs (Node runtime):
    - GET `/api/health` — pings manifest in S3
    - GET `/api/index` — returns the S3 manifest (tickers, asOf, source)
    - GET `/api/local-data?ticker=XYZ&start=YYYY-MM-DD&end=YYYY-MM-DD` — returns normalized OHLCV rows
    - POST `/api/strategy/generate` — `{ prompt } → { dsl }` using OpenAI
    - POST `/api/strategy/run` — executes `{ mode: "dsl" | "ml", dsl | code, tickers, startDate, endDate }`
- Libraries:
    - `lib/env.ts` — strict env loader (AWS_BUCKET, AWS_REGION, AWS_PREFIX, S3_BASE, OPENAI_*)
    - `lib/*` — ingestion/parquet fetch + strategy engine (indicators + backtest loop)
- Scripts:
    - `scripts/build-manifest.ts` — walks `s3://bucket/prefix/` and writes `index.json` (no ACLs)

- `app/`
    - `(shell)/layout.tsx` — tabbed layout + global store provider
    - `(shell)/dashboard/` — dashboard client with multi-select, indicators, charts
    - `(shell)/strategy/` — Strategy Lab server/client split with sector helpers
    - `(shell)/explore/` — Data Warehouse entry point and client
    - `backtester/` — legacy route (redirects to `/strategy`)
    - `api/` — Next.js API routes (Node runtime)
- `lib/`
    - `env.ts` — environment helpers
    - `safeParquet.ts`, `ingest-bars.ts` — Parquet/CSV loaders + normalization (see docs)
    - `strategy-engine.ts` — DSL execution, indicators (SMA/EMA/RSI/MACD)
- `scripts/`
    - `build-manifest.ts` — generates `index.json` manifest in S3
- `tests/`
    - `pages-exports.test.ts` — guard for invalid App Router exports
    - `dashboard-select.test.tsx` — ticker search, isolate, deep link
    - `dashboard-to-strategy-handoff.test.tsx` — store + navigation handoff
    - `chart-readability.test.tsx` — legend toggle, hover emphasis, scale modes
    - `strategy.client.test.tsx` — Strategy Lab prefills

## Data & Manifest

- S3 layout (example):
    - `s3://ai-backtester-data-rosh/prod/`
        - `AAPL.parquet`
        - `ABBV.parquet`
        - `...`
        - `index.json`  (generated by `build-manifest.ts`)

- Manifest example (trimmed):

        {
          "asOf": "2025-09-23T16:58:40.098Z",
          "source": "s3://ai-backtester-data-rosh/prod/",
          "tickers": ["AAPL","ABBV","..."]
        }

- Expected normalized row shape (before charts/backtests):

        {
          "date": "2025-01-02",
          "open": 170.2,
          "high": 172.0,
          "low": 169.5,
          "close": 171.8,
          "volume": 75000000
        }

## Environment Variables

Keep `.env.local` as the source of truth locally; replicate these in Vercel → Project Settings → Environment Variables (Production + Preview).

- Required:

        AWS_BUCKET=ai-backtester-data-rosh
        AWS_REGION=us-east-1
        AWS_PREFIX=prod
        S3_BASE=https://ai-backtester-data-rosh.s3.amazonaws.com/prod
        OPENAI_API_KEY=sk-...
        OPENAI_MODEL=gpt-4o-mini
        NEXT_PUBLIC_APP_URL=http://localhost:3000   # or your Vercel URL for prod

## Local Development

1) Install deps:

        npm ci

2) Build or refresh the S3 manifest:

        npm run build:manifest

3) Run dev server:

        npm run dev
        # http://localhost:3000

4) Quick smoke checks:

        curl.exe http://localhost:3000/api/health
        curl.exe http://localhost:3000/api/index | Select-Object -First 40
        curl.exe "http://localhost:3000/api/local-data?ticker=AAPL&start=2023-01-01&end=2024-12-31" | Select-Object -First 20

## Backtesting (Quick Start)

- Open `/dashboard`, select tickers/indicators/date range, then click **Create a strategy with this**.
- The Strategy Lab (`/strategy`) opens prefilled; refine the prompt if needed and click **Generate strategy**.
- Review the generated DSL, then click **Run backtest** to view equity curves, trades, and summary stats.

## Testing

- Type & unit tests:

        npm run typecheck
        npm run test

## Deploying to Vercel

1) Push `main` to your Git host (the one Vercel is connected to).
2) In Vercel Dashboard → Project → Environment Variables, add the variables listed above (Production + Preview).
3) Trigger a redeploy (Dashboard Redeploy or `vercel --prod`).
4) Verify:

        curl https://<your-app>/api/health
        curl https://<your-app>/api/index | Select-Object -First 40

## Troubleshooting

- Vercel build error: “stream did not contain valid UTF-8” for `app/.../page.tsx`  
  Cause: files saved with non-UTF-8 or CRLF; fix by re-saving as UTF-8 LF and committing `.gitattributes`:
    - Ensure editor saves `app/dashboard/page.tsx` and `app/strategy/page.tsx` as **UTF-8 (LF)**.
    - Add `.gitattributes` line: `* text=auto eol=lf`
    - Commit and redeploy.

- Charts flat at 0 for non-AAPL tickers  
  Most likely normalization gaps (schema variants, DECIMAL scales, BigInt). See `DOCUMENTATION.md` → Parquet normalization. Ensure the loader:
    - Maps aliases (open|o|OpenPrice, high|h|HighPrice, low|l|LowPrice, close|c|ClosePrice, volume|v|Volume)
    - Handles decimals (divide by 10^scale when applicable)
    - Converts BigInt/Int64 to JS number
    - Skips invalid rows rather than defaulting to 0

- Missing env variables  
  App uses `.env.local` automatically. For manual CLI tests, export needed vars into the shell or sync from `.env.local`.

## Notes

- Polygon is not required for core operation; S3 Parquet is the data source. Polygon can be used later for refresh jobs.
- ML strategies are scaffolded and intentionally disabled in serverless paths; wire up a Python service when ready.
